#! /usr/bin/bash
source checkName
insert_into_table(){
    DBName="$1" 
    TableName="$2"
    numOfFields=$(awk -F: '{print NF; exit}' "Database/$DBName/${TableName}_metaData")
    Name=($(awk -F: '{print $1}' "Database/$DBName/${TableName}_metaData"))
    DataType=($(awk -F: '{print $2}' "Database/$DBName/${TableName}_metaData"))
    PK=($(awk -F: '{print ($3 == "" ? "x" : $3)}' "Database/$DBName/${TableName}_metaData"))

   for ((i=0; i<$numOfFields; i++)); 
    do

            read -p "Enter the ${Name[$i]} " FieldName
            if [[ ${DataType[$i]} == "int" ]];then 
                checkValue=$(check_is_int $FieldName)
                if [[ $checkValue == 1 ]];then
                 ((i--))
                continue
                fi
            fi
            if [[ ${PK[$i]} != "pk" ]]; then

                if [[ $i == 0 ]]; then
                    echo -n "$FieldName" >> "Database/$DBName/${TableName}"
                else 
                   echo -n ":$FieldName" >> "Database/$DBName/${TableName}"
                fi

            else

                flag=0
                values=($(awk -F: -v col=$((i+1)) '{print $col}' "Database/$DBName/$TableName"))

                for ((x=0; x<${#values[@]}; x++)); do

                    if (( $FieldName == ${values[$x]} )); then
                        flag=1

                    fi

                done
                if [[ $flag == 1 ]];then

                    echo "OOP! can't repeat this values for ${Name[$i]} is unique"
                    ((i--))

                else

                    if [[ $i == 0 ]]; then
                        echo -n "$FieldName" >> "Database/$DBName/${TableName}"
                    else 
                        echo -n ":$FieldName" >> "Database/$DBName/${TableName}"
                    fi

                fi
            fi

    done
     printf "\n" >> "Database/$DBName/${TableName}"



}

deleteTable(){
    DBNameD="$1" 
    TableNameD="$2"

    select choice in "Delete All Data" "Delete by column" "Delete specific column" "Delete multiple column by name"
			do
				case $choice in
					"Delete All Data")
                        awk  '{next;}' "Database/$DBName/${TableName}" >"Database/$DBName/${TableName}" 
						break
						;;

					"Delete by column")
                        flagExist=0
                        flagDisplayErrorMessage=0
                        while [[ "$flagExist" == 0 ]];do 
                            if [[ "$flagDisplayErrorMessage" == 1 ]];then 
                                echo "Column Not Exist Try Again"
                            fi
                            read -p "Enter the condition to delete(coulmnName  specific value): " columnName  value
                            FieldNum=$(return_num_of_Field  $columnName  $DBNameD $TableNameD)
                            
                            Name1=($(awk -F: '{print $1}' "Database/$DBNameD/${TableNameD}_metaData"))
                            for ((l=0; l<${#Name1[@]}; l++)); do
                                echo $columnName
                                echo ${Name1[$l]}
                                if [[ $columnName == ${Name1[$l]} ]];then
                                    flagExist=1
                                    break
                                fi
                            done
                            echo "the flage test $flagExist"
                            echo $FieldNum
                            echo $value
                            if [[ "$flagExist" == 1 ]];then 
                                awk -F: -v fNum="$FieldNum" -v valuetest="$value" '{if($fNum == valuetest){next;} {print} }' "Database/$DBNameD/$TableNameD" > "Database/$DBNameD/${TableNameD}_temp"
                                mv "Database/$DBNameD/${TableNameD}_temp" "Database/$DBNameD/$TableNameD"
                            else
                               flagDisplayErrorMessage=1
                            fi 
                        done

						break
						;;

                    "Delete specific column")

                        flagExist2=0
                        flagDisplayErrorMessage2=0
                        while [[ "$flagExist2" == 0 ]];do 
                            if [[ "$flagDisplayErrorMessage2" == 1 ]];then 
                                echo "Column Not Exist Try Again"
                            fi
                            read -p "Enter the name of column you want to delete it: " columnName 
                            FieldNum=$(return_num_of_Field  $columnName  $DBNameD $TableNameD)

                        
                            Name1=($(awk -F: '{print $1}' "Database/$DBNameD/${TableNameD}_metaData"))
                            for ((l=0; l<${#Name1[@]}; l++)); do

                                if [[ $columnName == ${Name1[$l]} ]];then
                                    flagExist2=1
                               
                                fi
                            done

                            if [[ "$flagExist2" == 1 ]];then 
                                awk -F: -v fNum="$FieldNum" '{ for(v=1;v<=NF;v++) { if(fNum==v) $fNum=""; if(v==NF && fNum!=v){$v=$v} else if(v!=NF && fNum!=v) $v=$v":" } print }' "Database/$DBNameD/$TableNameD" > "Database/$DBNameD/${TableNameD}_temp"
                                mv "Database/$DBNameD/${TableNameD}_temp" "Database/$DBNameD/$TableNameD"

                                #delete from table_metaData
                                awk -F: -v numRow="$FieldNum" 'NR != numRow' "Database/$DBNameD/${TableNameD}_metaData" > "Database/$DBNameD/${TableNameD}_temp"
                                mv "Database/$DBNameD/${TableNameD}_temp" "Database/$DBNameD/${TableNameD}_metaData"
                            else
                               flagDisplayErrorMessage2=1
                            fi 
                        done
						break
						;;
                    "Delete multiple column by name")

                        while true ; do
                            Name2=($(awk -F: '{print $1}' "Database/$DBNameD/${TableNameD}_metaData"))
                            echo ================
                            echo Exist Columns
                            echo ================
                            for ((l=0; l<${#Name2[@]}; l++)); do
                            echo ${Name2[$l]}
                            echo ====================
                            done
                            flagExist3=0
                            flagDisplayErrorMessage3=0
                            while [[ "$flagExist3" == 0 ]];do 
                                if [[ "$flagDisplayErrorMessage3" == 1 ]];then 
                                    echo "Column Not Exist Try Again"
                                fi
                                read -p "DO you need to delete coulmn enter (y) if yes: " reply
                                if [[ $reply == "y" ]];then 

                                    read -p "Enter the name of column you want to delete it:" coName 
  
                                        for ((value=0; value<${#Name2[@]}; value++)); do
                                            if [[ $coName == ${Name2[$value]} ]];then
                                                flagExist3=1
                                
                                            fi
                                        done

                                        if [[ "$flagExist3" != 1 ]];then 
                                             flagDisplayErrorMessage3=1
                                        else
                                        delete_multiple_Column $coName  $DBNameD $TableNameD

                                        fi 
                                 

                                else
                                   break
                                fi
                            done
                            if [[ $reply != "y" ]];then 
                                break
                            fi
                        done 
                        break
						;;
					*) 
						echo $REPLY is not one of the choices.
						break
						;;
				esac
			done
}
return_num_of_Field(){
    fieldtest=$1
    DBNameT=$2
    TableNameT=$3
    Name=($(awk -F: '{print $1}' "Database/$DBNameT/${TableNameT}_metaData"))
    for ((z=0; z<${#Name[@]}; z++)); do
        if [[ "$fieldtest" == "${Name[$z]}" ]]; then 
            echo $((z+1))
            break
        fi
    done
}
delete_multiple_Column(){
    cName="$1"
    DBNamex="$2"
    TableNamex="$3"

    FieldNum=$(return_num_of_Field "$cName" "$DBNamex" "$TableNamex")

    awk -F: -v fNum="$FieldNum" '{ for(v=1;v<=NF;v++) { if(fNum==v) $fNum=""; if(v==NF && fNum!=v){$v=$v} else if(v!=NF && fNum!=v) $v=$v":" } print }' "Database/$DBNamex/$TableNamex" > "Database/$DBNamex/${TableNamex}_temp"
    mv "Database/$DBNamex/${TableNamex}_temp" "Database/$DBNamex/$TableNamex"

    # delete from table_metaData
    awk -F: -v numRow="$FieldNum" 'NR != numRow' "Database/$DBNamex/${TableNamex}_metaData" > "Database/$DBNamex/${TableNamex}_temp"
    mv "Database/$DBNamex/${TableNamex}_temp" "Database/$DBNamex/${TableNamex}_metaData"


}
#deleteTable "MyDatabase" "kk"
#return_num_of_Field name  "MyDatabase" "kk"
